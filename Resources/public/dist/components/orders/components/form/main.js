define(["sulusalesorder/util/sidebar","sulusalesorder/util/orderStatus","sulusalescore/util/helper","sulucontact/model/account","config","widget-groups"],function(a,b,c,d,e,f){"use strict";var g="#order-form",h={currencyCode:"EUR"},i={accountContactsUrl:"/admin/api/accounts/<%= id %>/contacts?flat=true",accountAddressesUrl:"/admin/api/accounts/<%= id %>/addresses",accountInputId:"#account-input",deliveryAddressInstanceName:"delivery-address",billingAddressInstanceName:"billing-address",currencySelectInstanceName:"currency-select",currencySelectSelector:"#currency-select",itemTableInstanceName:"order-items",itemTableSelector:"#order-items",paymentTermsInstanceName:"payment-terms",deliveryTermsInstanceName:"delivery-terms",contactSelectId:"#contact-select",validateWarningTranslation:"form.validation-warning",translationConversionFailed:"salescore.conversion-failed",translationShippingFailed:"salescore.shipping-failed",autocompleteLimit:20},j=function(){var a,b,c,d=null,e=this.options.data,f=[{id:"save-button",icon:"floppy-o",iconSize:"large","class":"highlight",position:1,group:"left",disabled:!0,callback:function(){this.sandbox.emit("sulu.header.toolbar.save")}.bind(this)}],g={icon:"hand-o-right",iconSize:"large",group:"left",id:"workflow",position:40,items:[]},h={divider:!0};if(this.options.data.id){for(a=-1,b=e.workflows.length;++a<b;)c=e.workflows[a],0===g.items.length?d=c.section:d&&d!==c.section&&(g.items.push(h),d=c.section),g.items.push({title:this.sandbox.translate(c.title),callback:k.bind(this,c)});g.items.length>0&&f.push(g)}this.sandbox.emit("sulu.header.set-toolbar",{template:f})},k=function(a){if(a.hasOwnProperty("event")&&a.event){var b=a.parameters||null;this.sandbox.emit(a.event,b)}else a.hasOwnProperty("route")&&a.route?o.call(this,function(){this.sandbox.emit("sulu.router.navigate",a.route)}.bind(this),n.bind(this,"")):this.sandbox.logger.log("no route or event provided for workflow with title "+a.title)},l=function(){o.call(this,function(){this.sandbox.emit("sulu.salesorder.order.confirm")},n.bind(this,i.translationConversionFailed))},m=function(){o.call(this,function(){this.sandbox.emit("sulu.salesorder.order.edit")},n.bind(this,i.translationConversionFailed))},n=function(a){this.sandbox.emit("sulu.labels.error.show",this.sandbox.translate(a))},o=function(a,b){"function"==typeof a&&(this.saved?a.call(this):this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.save-unsaved-changes-confirm",null,function(){this.submit().then(a.bind(this),b.bind(this))}.bind(this)))},p=function(){return this.options.data&&this.options.data.status?this.options.data.status.id:null},q=function(a){this.options.orderStatuses=a},r=function(a){this.options.currencies=a},s=function(){this.sandbox.on("sulu.salesorder.order.edit.clicked",m.bind(this)),this.sandbox.on("sulu.salesorder.order.confirm.clicked",l.bind(this)),this.sandbox.on("sulu.salesorder.set-order-status",q.bind(this)),this.sandbox.on("sulu.salesorder.set-currencies",r.bind(this)),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".initialized",function(){this.isEditable||this.sandbox.dom.attr(this.$find(i.accountInputId+" input"),"disabled","disabled"),this.dfdAutoCompleteInitialized.resolve()},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".selection-removed",C.bind(this)),this.sandbox.on("sulu.salesorder.order.saved",function(a){this.options.data=a,t.call(this,!0),this.dfdFormSaved.resolve()},this),this.sandbox.on("sulu.header.toolbar.save",function(){this.submit()},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.salesorder.orders.list")},this),this.sandbox.on("husky.input.shipping-date.initialized",function(){this.dfdShippingDate.resolve()},this),this.sandbox.on("husky.input.order-date.initialized",function(){this.dfdOrderDate.resolve()},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".select",C.bind(this)),this.sandbox.on("sulu.editable-data-row."+i.deliveryAddressInstanceName+".initialized",function(){this.dfdDeliveryAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row."+i.billingAddressInstanceName+".initialized",function(){this.dfdInvoiceAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view."+i.deliveryAddressInstanceName+".changed",function(a){this.options.data.deliveryAddress=a,v.call(this,this.options.data),D.call(this)}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view."+i.billingAddressInstanceName+".changed",function(a){this.options.data.invoiceAddress=a,v.call(this,this.options.data),D.call(this)}.bind(this)),this.sandbox.on("husky.select."+i.currencySelectInstanceName+".selected.item",function(a){this.sandbox.emit("sulu.item-table."+i.itemTableInstanceName+".change-currency",a),this.currency=a},this),this.sandbox.on("sulu.salesorder.set-customer-id",function(a){this.customerId=a},this)},t=function(a){if(a!==this.saved){var b=this.options.data&&this.options.data.id?"edit":"add";this.sandbox.emit("sulu.header.toolbar.state.change",b,a,!0)}this.saved=a},u=function(a){var b=this.sandbox.form.create(g);b.initialized.then(function(){v.call(this,a,!0),w.call(this,a)}.bind(this))},v=function(a){this.sandbox.form.setData(g,a).then(function(){this.accountId=x.call(this)}.bind(this)).fail(function(a){this.sandbox.logger.error("An error occured when setting data!",a)}.bind(this))},w=function(a){this.sandbox.start(g),a.customerAccount&&a.customerAccount.id&&E.call(this,a.customerAccount.id,a);var b=e.get("sulucontact.components.autocomplete.default.account");b.el=i.accountInputId,b.value=a.customerAccount?a.customerAccount:"",b.instanceName=this.accountInstanceName,b.remoteUrl+="&type="+this.customerId+"&limit="+i.autocompleteLimit,b.limit=i.autocompleteLimit,this.sandbox.start([{name:"auto-complete@husky",options:b}])},x=function(){return this.sandbox.dom.attr(i.accountInputId,"data-id")},y=function(a,b){b=b||[],this.sandbox.emit("husky.select.contact-select.update",a,b)},z=function(a,b,c){this.sandbox.emit("sulu.editable-data-row."+b+".data.update",a,c)},A=function(a,b){this.sandbox.emit("sulu.editable-data-row."+a+".set-value",b)},B=function(a,b){this.sandbox.emit("sulu.item-table."+i.itemTableInstanceName+".set-addresses",a,b)},C=function(a){var b=a.id||null;b!==this.accountId&&(this.accountId=b,b?E.call(this,b):(y.call(this,[]),z.call(this,[],i.deliveryAddressInstanceName),z.call(this,[],i.billingAddressInstanceName),B.call(this,[])))},D=function(){t.call(this,!1)},E=function(a,b){var c,e,f,g;f=d.findOrCreate({id:a}),f.fetch({success:function(a){f=a.toJSON();var c=null,d=null;b||(f.hasOwnProperty("termsOfDelivery")&&f.termsOfDelivery&&(d=f.termsOfDelivery.terms),A.call(this,i.deliveryTermsInstanceName,d),f.hasOwnProperty("termsOfPayment")&&f.termsOfPayment&&(c=f.termsOfPayment.terms),A.call(this,i.paymentTermsInstanceName,c)),f.hasOwnProperty("addresses")&&(g=f.addresses,e=null,b&&b.deliveryAddress?e=b.deliveryAddress:(e=G.call(this,g,"deliveryAddress",!0),!e&&g.length>0&&(e=g[0])),this.sandbox.data.when(this.dfdDeliveryAddressInitialized).then(function(){z.call(this,g,i.deliveryAddressInstanceName,e),B.call(this,g,e),this.options.data.deliveryAddress=e}.bind(this)),e=null,b&&b.invoiceAddress?e=b.invoiceAddress:(e=G.call(this,g,"billingAddress",!0),!e&&g.length>0&&(e=g[0])),this.sandbox.data.when(this.dfdInvoiceAddressInitialized).then(function(){z.call(this,g,i.billingAddressInstanceName,e),this.options.data.invoiceAddress=e}.bind(this)))}.bind(this),error:function(){this.sandbox.emit("sulu.labels.warning.show",this.sandbox.translate("error while fetching account"))}.bind(this)}),this.sandbox.util.load(this.sandbox.util.template(i.accountContactsUrl,{id:a})).then(function(a){c=a._embedded.contacts,e=b&&b.customerContact?[b.customerContact.id]:null,y.call(this,c,e)}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this))},F=function(a,b){var c=[];return this.sandbox.util.each(b,function(d){return b[d].code===a?(c.push(b[d].id),!1):void 0}.bind(this)),c},G=function(a,b,c){var d=null;return a&&a.length>0&&this.sandbox.util.each(a,function(a,e){return e.hasOwnProperty(b)&&e[b]===c?(d=e,!1):void 0}.bind(this)),d};return{view:!0,layout:{sidebar:{width:"fixed",cssClasses:"sidebar-padding-50"}},templates:["/admin/order/template/order/form"],initialize:function(){this.saved=!0,this.formId=g,this.accountId=null,this.contactId=null,this.dfdFormSaved=this.sandbox.data.deferred(),this.dfdAllFieldsInitialized=this.sandbox.data.deferred(),this.dfdAutoCompleteInitialized=this.sandbox.data.deferred(),this.dfdShippingDate=this.sandbox.data.deferred(),this.dfdOrderDate=this.sandbox.data.deferred(),this.dfdInvoiceAddressInitialized=this.sandbox.data.deferred(),this.dfdDeliveryAddressInitialized=this.sandbox.data.deferred(),this.sandbox.data.when(this.dfdShippingDate,this.dfdOrderDate,this.dfdAutoCompleteInitialized).then(function(){this.dfdAllFieldsInitialized.resolve()}.bind(this)),this.orderStatusId=p.call(this),this.isEditable=this.orderStatusId<=b.IN_CART,this.options.data=this.sandbox.util.extend({},h,this.options.data);var c=this.options.data.id?this.options.data.id:"new";this.accountInstanceName="customerAccount"+c,s.call(this),j.call(this),t.call(this,!0),this.render(),this.listenForChange(),this.options.data&&this.options.data.id&&f.exists("order-detail")&&a.initForDetail(this.sandbox,this.options.data)},render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate(this.templates[0],{isEditable:this.isEditable,parseDate:c.parseDate}));var a=this.options.data;u.call(this,a),this.startItemTableAndCurrencySelect()},startItemTableAndCurrencySelect:function(){this.sandbox.start([{name:"item-table@sulusalescore",options:{instanceName:i.itemTableInstanceName,isEditable:this.isEditable,remoteUrl:i.accountUrl,data:this.options.data.items,currency:this.options.data.currencyCode,el:i.itemTableSelector,settings:{columns:["addresses","description","quantity","single-price","delivery-date","cost-center","discount","tax-rate"]}}},{name:"select@husky",options:{el:i.currencySelectSelector,instanceName:i.currencySelectInstanceName,disabled:!this.isEditable,emitValues:!0,defaultLabel:this.sandbox.translate("dropdown.please-choose"),multipleSelect:!1,repeatSelect:!1,valueName:"code",data:this.options.currencies,preSelectedElements:F.call(this,this.options.data.currencyCode,this.options.currencies)}}])},submit:function(){if(this.dfdFormSaved=this.sandbox.data.deferred(),this.sandbox.logger.log("save Model"),this.sandbox.form.validate(g)){var a=this.sandbox.form.getData(g);""===a.id&&delete a.id,a.currencyCode=this.currency?this.currency:this.options.data.currencyCode,a.customerAccount={id:this.sandbox.dom.attr("#"+this.accountInstanceName,"data-id")},this.sandbox.logger.log("log data",a),this.sandbox.emit("sulu.salesorder.order.save",a)}else this.sandbox.emit("sulu.labels.warning.show",this.sandbox.translate(i.validateWarningTranslation)),this.dfdFormSaved.reject();return this.dfdFormSaved},listenForChange:function(){this.sandbox.data.when(this.dfdAllFieldsInitialized).then(function(){this.sandbox.dom.on(g,"change",D.bind(this),".changeListener select, .changeListener input, .changeListener .husky-select, .changeListener textarea"),this.sandbox.dom.on(g,"keyup",D.bind(this),".changeListener select, .changeListener input, .changeListener textarea"),this.sandbox.on("sulu.item-table.changed",D.bind(this))}.bind(this))}}});