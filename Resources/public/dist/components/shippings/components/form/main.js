define(["sulusalesshipping/util/shippingStatus"],function(a){"use strict";var b="#shipping-form",c={shippedOrderItems:null},d={accountId:"#account",contactId:"#contact",accountAddressesUrl:"/admin/api/accounts/<%= id %>/addresses",deliveryAddressInstanceName:"delivery-address",validateWarningTranslation:""},e=function(){var b=[{id:"save-button",icon:"floppy-o",iconSize:"large","class":"highlight",position:1,group:"left",disabled:!0,callback:function(){this.sandbox.emit("sulu.header.toolbar.save")}.bind(this)}],c={icon:"gear",iconSize:"large",group:"left",id:"options-button",position:30,items:[{title:this.sandbox.translate("toolbar.delete"),callback:function(){this.sandbox.emit("sulu.header.toolbar.delete")}.bind(this)}]},d={icon:"hand-o-right",iconSize:"large",group:"left",id:"workflow",position:40,items:[]},e={confirm:{title:this.sandbox.translate("salesshipping.shippings.confirm"),callback:f.bind(this)},edit:{title:this.sandbox.translate("salesshipping.shippings.edit"),callback:g.bind(this)},ship:{title:this.sandbox.translate("salesshipping.shippings.ship"),callback:h.bind(this)},cancel:{title:this.sandbox.translate("salesshipping.shippings.cancel"),callback:i.bind(this)},divider:{divider:!0}};this.options.data.id&&(this.shippingStatusId===a.CREATED?d.items.push(e.confirm):this.shippingStatusId===a.DELIVERY_NOTE?(d.items.push(e.edit),d.items.push(e.divider),d.items.push(e.ship)):this.shippingStatusId===a.SHIPPED&&d.items.push(e.cancel),c.items.length>0&&b.push(c),d.items.length>0&&b.push(d)),this.sandbox.emit("sulu.header.set-toolbar",{template:b})},f=function(){j.call(this,function(){this.sandbox.emit("sulu.salesshipping.shipping.confirm")})},g=function(){j.call(this,function(){this.sandbox.emit("sulu.salesshipping.shipping.edit")})},h=function(){j.call(this,function(){this.sandbox.emit("sulu.salesshipping.shipping.ship")})},i=function(){j.call(this,function(){this.sandbox.emit("sulu.salesshipping.shipping.cancel")})},j=function(a){if("function"!=typeof a)throw"checkForUnsavedData: callback is not a function";this.saved?a.call(this):this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.unsaved-changes-confirm",null,a.bind(this))},k=function(){return this.options.data&&this.options.data.status?this.options.data.status.id:null},l=function(){this.sandbox.on("sulu.header.toolbar.delete",function(){this.sandbox.emit("sulu.salesshipping.shipping.delete",this.options.data.id)},this),this.sandbox.on("sulu.salesshipping.shipping.saved",function(a){this.options.data=a,n.call(this,!0)},this),this.sandbox.on("sulu.header.toolbar.save",function(){this.submit()},this),this.sandbox.on("husky.toolbar.header.initialized",function(){n.call(this,!this.isNew)}.bind(this)),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.salesshipping.shippings.list")},this),this.sandbox.on("husky.input.expected-delivery-date.initialized",function(){this.dfdExpectedDeliveryDate.resolve()},this),this.sandbox.on("sulu.editable-data-row.delivery-address.initialized",function(){this.dfdDeliveryAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view.delivery-address.changed",function(a){this.options.data.deliveryAddress=a,p.call(this,this.options.data),s.call(this)}.bind(this))},m=function(){var a=this.sandbox.translate("salesshipping.shipping"),b=[{title:"navigation.sales"},{title:"salesshipping.shippings.title",event:"salesshipping.shippings.list"}];this.options.data&&this.options.data.number&&(a+=" #"+this.options.data.number,b.push({title:"#"+this.options.data.number})),this.sandbox.emit("sulu.header.set-title",a),this.sandbox.emit("sulu.header.set-breadcrumb",b)},n=function(a){if(a!==this.saved){var b=this.options.data&&this.options.data.id?"edit":"add";this.sandbox.emit("sulu.header.toolbar.state.change",b,a,!0)}this.saved=a},o=function(a){var c=this.sandbox.form.create(b);c.initialized.then(function(){p.call(this,a,!0),r.call(this,a)}.bind(this))},p=function(a){this.sandbox.form.setData(b,a).then(function(){a.hasOwnProperty("deliveryAddress")&&(this.sandbox.dom.html(this.$find(d.accountId),a.deliveryAddress.accountName),this.sandbox.dom.html(this.$find(d.contactId),a.deliveryAddress.firstName+" "+a.deliveryAddress.lastName))}.bind(this)).fail(function(a){this.sandbox.logger.error("An error occured when setting data!",a)}.bind(this))},q=function(a){this.sandbox.util.load(this.sandbox.util.template(d.accountAddressesUrl,{id:a.order.account.id})).then(function(b){var c=b._embedded.addresses,e=null;a&&a.deliveryAddress?e=a.deliveryAddress:a&&a.hasOwnProperty("order")?e=a.order.deliveryAddress:!e&&c.length>0&&(e=c[0]),this.sandbox.data.when(this.dfdDeliveryAddressInitialized).then(function(){this.sandbox.emit("sulu.editable-data-row."+d.deliveryAddressInstanceName+".data.update",c,e),this.options.data.deliveryAddress=e,p.call(this,this.options.data),this.dfdAddressSet.resolve()}.bind(this))}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this))},r=function(a){this.sandbox.start(b),q.call(this,a)},s=function(){n.call(this,!1)};return{view:!0,layout:{},templates:["/admin/shipping/template/shipping/form"],initialize:function(){this.options=this.sandbox.util.extend({},c,this.options),this.saved=!0,this.isNew=!this.options.data.id,this.dfdAllFieldsInitialized=this.sandbox.data.deferred(),this.dfdExpectedDeliveryDate=this.sandbox.data.deferred(),this.dfdDesiredDeliveryDate=this.sandbox.data.deferred(),this.dfdAddressSet=this.sandbox.data.deferred(),this.dfdDeliveryAddressInitialized=this.sandbox.data.deferred(),this.sandbox.data.when(this.dfdExpectedDeliveryDate,this.dfdAddressSet).then(function(){this.dfdAllFieldsInitialized.resolve()}.bind(this)),this.shippingStatusId=k.call(this),this.isEditable=!this.shippingStatusId||this.shippingStatusId===a.CREATED,l.call(this),m.call(this),e.call(this),this.render(),this.listenForChange()},initSidebar:function(a,b){this.sandbox.emit("sulu.sidebar.set-widget",a+b)},render:function(){var a=this.options.data,b=this.sandbox.util.extend({},{isEditable:this.isEditable,isNew:this.isNew,shippedOrderItems:this.options.shippedOrderItems},a);this.sandbox.dom.html(this.$el,this.renderTemplate(this.templates[0],b)),o.call(this,a)},submit:function(){if(this.sandbox.logger.log("save Model"),this.sandbox.form.validate(b)){var a=this.sandbox.form.getData(b);""===a.id&&delete a.id,this.sandbox.logger.log("log data",a),this.sandbox.emit("sulu.salesshipping.shipping.save",a)}else this.sandbox.emit("sulu.labels.warning.show",this.sandbox.translate(d.validateWarningTranslation))},listenForChange:function(){this.sandbox.data.when(this.dfdAllFieldsInitialized).then(function(){this.sandbox.dom.on(b,"change",s.bind(this),".changeListener select, .changeListener input, .changeListener .husky-select, .changeListener textarea"),this.sandbox.dom.on(b,"keyup",s.bind(this),".changeListener select, .changeListener input, .changeListener textarea"),this.sandbox.on("sulu.item-table.changed",s.bind(this))}.bind(this))}}});